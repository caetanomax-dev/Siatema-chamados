<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Chamados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#f4f6f8}
.layout{display:flex;min-height:100vh}
.sidebar{width:260px;background:#111827;color:#fff;padding:20px}
.sidebar img{max-height:50px;margin-bottom:10px}
.sidebar button{width:100%;background:none;border:none;color:#d1d5db;padding:12px;text-align:left;border-radius:6px;cursor:pointer;margin-bottom:6px}
.sidebar button.active,.sidebar button:hover{background:#2563eb;color:#fff}
.content{flex:1;padding:20px}
.hidden{display:none}

.btn{background:#2563eb;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer}
.btn-danger{background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px}

table{width:100%;border-collapse:collapse;background:#fff;margin-top:15px}
th,td{padding:8px;border-bottom:1px solid #e5e7eb}
th{background:#f9fafb}

.status{padding:4px 10px;border-radius:999px;font-size:12px;cursor:pointer}
.pendente{background:#fde68a}
.resolvido{background:#bbf7d0}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:420px;max-height:90vh;overflow:auto}
.modal-content input,textarea{width:100%;margin-bottom:8px;padding:6px}
.readonly textarea{background:#f3f4f6}
</style>
</head>

<body>

<div class="layout">
<aside class="sidebar">
  <img id="logoEmpresa" class="hidden">
  <h3 id="nomeEmpresa">Sistema</h3>
  <button class="active" onclick="app.aba('chamados',this)">üìã Chamados</button>
  <button onclick="app.aba('clientes',this)">üë• Clientes</button>
  <button onclick="app.aba('relatorios',this)">üìä Relat√≥rios</button>
  <button onclick="app.aba('config',this)">‚öôÔ∏è Configura√ß√µes</button>
</aside>

<main class="content">

<!-- CHAMADOS -->
<section id="chamados">
<button class="btn" onclick="app.abrirModal()">+ Novo Chamado</button>
<table>
<thead>
<tr>
<th>ID</th><th>Data</th><th>Cliente</th><th>Solicitante</th>
<th>T√©cnico</th><th>Descri√ß√£o</th><th>Status</th>
</tr>
</thead>
<tbody id="listaChamados"></tbody>
</table>
</section>

<!-- CLIENTES -->
<section id="clientes" class="hidden">
<ul id="listaClientes"></ul>
</section>

<!-- RELAT√ìRIOS -->
<section id="relatorios" class="hidden">
<input id="fCliente" placeholder="Cliente">
<input id="fSolicitante" placeholder="Solicitante">
<input id="fTecnico" placeholder="T√©cnico">
<input type="date" id="fDataInicio">
<input type="date" id="fDataFim">
<select id="fStatus">
<option value="">Todos</option>
<option value="pendente">Pendente</option>
<option value="resolvido">Resolvido</option>
</select>
<button class="btn" onclick="app.relatorio()">Filtrar</button>

<table>
<thead>
<tr>
<th>ID</th><th>Data</th><th>Cliente</th><th>Solicitante</th>
<th>T√©cnico</th><th>Status</th><th>Cronologia</th>
</tr>
</thead>
<tbody id="resultadoRelatorio"></tbody>
</table>
</section>

<!-- CONFIG -->
<section id="config" class="hidden">
<input id="confEmpresa" placeholder="Nome da empresa">
<input id="confLogo" placeholder="URL da logo">
<button class="btn" onclick="app.salvarConfig()">Salvar</button>
</section>

</main>
</div>

<!-- MODAL CHAMADO -->
<div id="modal" class="modal">
<div class="modal-content">
<input id="mCliente" placeholder="Cliente">
<input id="mSolicitante" placeholder="Solicitante">
<input id="mTecnico" placeholder="T√©cnico">
<textarea id="mDescricao" placeholder="Descri√ß√£o"></textarea>
<button class="btn" onclick="app.salvarChamado()">Salvar</button>
<button class="btn-danger" onclick="app.fecharModal()">Cancelar</button>
</div>
</div>

<!-- MODAL CRONOLOGIA -->
<div id="modalCronologia" class="modal">
<div class="modal-content" id="cronBox">
<h4>Cronologia</h4>
<div id="listaCronologia"></div>
<textarea id="novaAtualizacao" placeholder="Nova atualiza√ß√£o"></textarea>
<button id="btnSalvarCrono" class="btn" onclick="app.salvarAtualizacao()">Adicionar</button>
<button class="btn-danger" onclick="app.fecharCronologia()">Fechar</button>
</div>
</div>

<script>
const SUPABASE_URL = 'https://boendmrotsttljydigld.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZW5kbXJvdHN0dGxqeWRpZ2xkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTI5NTksImV4cCI6MjA4MjE2ODk1OX0.k6vVvD6kNV8r-a9lR6jaTcAm1wz5c_jbTDnjKlpo0cE';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const hoje = new Date().toISOString().slice(0,10);
let chamadoAtual = null;
let modoCronologia = 'leitura';

const app = {

aba(id,btn){
document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
document.getElementById(id).classList.remove('hidden');
document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
},

abrirModal(){modal.classList.add('active')},
fecharModal(){modal.classList.remove('active')},

async carregarChamados(){
const {data} = await supabaseClient.from('chamados').select('*').order('id',{ascending:false});
listaChamados.innerHTML='';
data.forEach(c=>{
if(c.status==='resolvido' && c.data!==hoje) return;
listaChamados.innerHTML+=`
<tr>
<td>${c.id}</td>
<td>${c.data}</td>
<td>${c.cliente}</td>
<td>${c.solicitante}</td>
<td>${c.tecnico}</td>
<td style="cursor:pointer;text-decoration:underline"
onclick="app.abrirCronologia(${c.id},'${c.status}','chamados')">${c.descricao}</td>
<td><span class="status ${c.status}"
onclick="app.toggle(${c.id},'${c.status}')">${c.status}</span></td>
</tr>`;
});
},

async salvarChamado(){
await supabaseClient.from('chamados').insert({
cliente:mCliente.value,
solicitante:mSolicitante.value,
tecnico:mTecnico.value,
descricao:mDescricao.value,
status:'pendente'
});
this.fecharModal();
this.carregarChamados();
},

async toggle(id,status){
const novo = status==='pendente'?'resolvido':'pendente';
await supabaseClient.from('chamados').update({status:novo}).eq('id',id);
this.carregarChamados();
},

abrirCronologia(id,status,origem){
chamadoAtual=id;
modoCronologia = origem==='relatorios' || status!=='pendente' ? 'leitura' : 'edicao';
modalCronologia.classList.add('active');
novaAtualizacao.style.display = modoCronologia==='edicao'?'block':'none';
btnSalvarCrono.style.display = modoCronologia==='edicao'?'block':'none';
this.carregarCronologia();
},

fecharCronologia(){
modalCronologia.classList.remove('active');
listaCronologia.innerHTML='';
novaAtualizacao.value='';
},

async carregarCronologia(){
const {data} = await supabaseClient.from('cronologia_chamados')
.select('*').eq('chamado_id',chamadoAtual).order('data');
listaCronologia.innerHTML='';
data.forEach(c=>{
listaCronologia.innerHTML+=`<div>[${new Date(c.data).toLocaleString()}] ${c.descricao}</div>`;
});
},

async salvarAtualizacao(){
if(modoCronologia!=='edicao') return;
await supabaseClient.from('cronologia_chamados')
.insert({chamado_id:chamadoAtual,descricao:novaAtualizacao.value});
novaAtualizacao.value='';
this.carregarCronologia();
},

async relatorio(){
let q = supabaseClient.from('chamados').select('*');
if(fCliente.value) q=q.ilike('cliente','%'+fCliente.value+'%');
if(fSolicitante.value) q=q.ilike('solicitante','%'+fSolicitante.value+'%');
if(fTecnico.value) q=q.ilike('tecnico','%'+fTecnico.value+'%');
if(fStatus.value) q=q.eq('status',fStatus.value);
if(fDataInicio.value) q=q.gte('data',fDataInicio.value);
if(fDataFim.value) q=q.lte('data',fDataFim.value);

const {data} = await q.order('id',{ascending:false});
resultadoRelatorio.innerHTML='';
data.forEach(c=>{
resultadoRelatorio.innerHTML+=`
<tr>
<td>${c.id}</td><td>${c.data}</td><td>${c.cliente}</td>
<td>${c.solicitante}</td><td>${c.tecnico}</td>
<td>${c.status}</td>
<td><button class="btn"
onclick="app.abrirCronologia(${c.id},'${c.status}','relatorios')">üìú</button></td>
</tr>`;
});
},

async salvarConfig(){
await supabaseClient.from('configuracoes')
.upsert({id:1,empresa:confEmpresa.value,logo_url:confLogo.value});
this.carregarConfig();
},

async carregarConfig(){
const {data} = await supabaseClient.from('configuracoes').select('*').eq('id',1).single();
if(!data)return;
nomeEmpresa.innerText=data.empresa;
confEmpresa.value=data.empresa;
confLogo.value=data.logo_url;
if(data.logo_url){logoEmpresa.src=data.logo_url;logoEmpresa.classList.remove('hidden')}
},

init(){
this.carregarChamados();
this.carregarConfig();
}
};

app.init();
</script>

</body>
</html>
